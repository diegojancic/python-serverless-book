<!DOCTYPE html>
<html lang="en-us">
<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
 <title>Deploying PIL/Pillow to AWS Lambda  </title>



<meta name="description" content="The starting point to learn Serverless programming.">


<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="robots" content="all,follow">
<meta name="googlebot" content="index,follow,snippet,archive">
<link rel="stylesheet" id="ct-tracks-google-fonts-css" href="//fonts.googleapis.com/css?family=Raleway%3A400%2C700&amp;subset=latin%2Clatin-ext&amp;ver=4.7.2" type="text/css" media="all">
<link rel="stylesheet" href="https://d2wg8k1x5s4bdi.cloudfront.net/css/font-awesome.min.css" type='text/css' media='all'>

<link href="https://d2wg8k1x5s4bdi.cloudfront.net/css/style.css" rel="stylesheet" id="theme-stylesheet" type='text/css' media='all'>

<link href="https://d2wg8k1x5s4bdi.cloudfront.net/css/custom.css" rel="stylesheet" type='text/css' media='all'>
<link rel="shortcut icon" href="https://d2wg8k1x5s4bdi.cloudfront.net/img/favicon.ico" type="image/x-icon">
<link rel="icon" href="https://d2wg8k1x5s4bdi.cloudfront.net/img/favicon.ico" type="image/x-icon">


</head>


<body class="post-template-default single single-post single-format-standard ct-body singular singular-post not-front standard">
  
  <div id="overflow-container" class="overflow-container">
    <a class="skip-content" href="#main">Skip to content</a>
    <header id="site-header" class="site-header" role="banner">
      <div class='top-navigation'>
        <div class='container'>

  <div id="menu-secondary" class="menu-container menu-secondary" role="navigation">
    <button id="toggle-secondary-navigation" class="toggle-secondary-navigation"><i class="fa fa-plus"></i></button>

    <div class="menu">

      <ul id="menu-secondary-items" class="menu-secondary-items">
        
        <li id="menu-item" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item">
          <a href="/categories/articles">articles</a>
        </li>
        

      </ul>

    </div>

  </div>


  <ul class="social-media-icons">


    

    

    
    <li>
      <a href="https://twitter.com/learnsrvless" data-animate-hover="pulse" class="twitter" target="_blank">
        <i class="fa fa-twitter-square" title="twitter"></i>
        <span class="screen-reader-text">twitter</span>
      </a>
    </li>
    

    

    
    <li>
      <a href="mailto:hello@learn-serverless.org" data-animate-hover="pulse" class="email">
        <i class="fa fa-envelope" title="email"></i>
        <span class="screen-reader-text">email</span>
      </a>
    </li>
    

    

    


    

  </ul></div>

      </div>

      <div class="container">
        <div id="title-info" class="title-info">
  <div id='site-title' class='site-title'>
    
    <a href="/"> Learn-Serverless.org </a>
    </div>
  </div>
  <button id="toggle-navigation" class="toggle-navigation">
    <i class="fa fa-bars"></i>
  </button>

  <div id="menu-primary-tracks" class="menu-primary-tracks"></div>
  <div id="menu-primary" class="menu-container menu-primary" role="navigation">
    
    <p class="site-description">We're everywhere.</p>
    

    <div class="menu">
      <ul id="menu-primary-items" class="menu-primary-items">
        
        
        <li id="menu-item" class='menu-item menu-item-type-custom menu-item-object-custom '>
          <a href="https://d2wg8k1x5s4bdi.cloudfront.net/">Home</a>
        </li>
        
        <li id="menu-item" class='menu-item menu-item-type-post_type menu-item-object-page '>
          <a href="https://d2wg8k1x5s4bdi.cloudfront.net/about/">About</a>
        </li>
        
        <li id="menu-item" class='menu-item menu-item-type-post_type menu-item-object-page '>
          <a href="https://d2wg8k1x5s4bdi.cloudfront.net/contact/">Publish in this site</a>
        </li>
        
      </ul>
    </div>

  </div>

      </div>
    </header>

    <div id="main" class="main" role="main">

      
  <div id="loop-container" class="loop-container">
    
    <div class="post type-post status-publish format-standard has-post-thumbnail hentry category-design tag-design tag-standard-2 tag-tagalicious tag-travel entry full-without-featured odd excerpt-1">

      <div class='featured-image lazy lazy-bg-image' data-background="https://d2wg8k1x5s4bdi.cloudfront.net/img/posts/pillow.jpg">
      </div>
      
        <div class="entry-meta">
          <span class="date">November 21</span>	<span> / </span>

          <span class="author">
            
            
            
          </span>


          
          <span class="category">
            <span> / </span>

            <a href="/categories/articles">articles</a>
          </span>
          


        </div>
        <div class='entry-header'>
          <h1 class='entry-title'> Deploying PIL/Pillow to AWS Lambda </h1>
        </div>
        <div class="entry-container">
          <div class="entry-content">
            <article>
              <p>When going serverless with Python and AWS Lambda, one of the first things we want to do is upload libraries, such as PIL. There are amazing tools to do this, such as Zappa, but&hellip; what if we want to do it with that?
</p>

<p>We are going to use Docker to build our libraries. If it doesn&rsquo;t work for the library you are trying to compile, you should do the same using one the Amazon EC2 instances as described <a href="http://docs.aws.amazon.com/lambda/latest/dg/current-supported-versions.html">in the documentation</a>.</p>

<p>Let&rsquo;s create a file <code>ProcessMediaFile.py</code> that grabs an image as soon as it&rsquo;s uploaded, resizes it, and puts it in another bucket:</p>

<pre><code>import boto3
import os
import sys
import uuid
from PIL import Image, ImageOps

s3_client = boto3.client('s3')

def resize_image(image_path, resized_path):
    with Image.open(image_path) as image:
        thumb = ImageOps.fit(image, (200,200), Image.ANTIALIAS)
        thumb.save(resized_path)

def lambda_handler(event, context):
    for record in event['Records']:
        bucket_input = record['s3']['bucket']['name']
        bucket_output = &quot;output-bucket-name&quot;

        key = record['s3']['object']['key']
        download_path = '/tmp/{}{}'.format(uuid.uuid4(), key)
        upload_path = '/tmp/resized-{}'.format(key)

        s3_client.download_file(bucket_input, key, download_path)
        resize_image(download_path, upload_path)
        s3_client.upload_file(upload_path, bucket_output, key)
</code></pre>

<p>The entrypoint will be the <code>lambda_handler</code> function, which we will set later.</p>

<p>Then, we launch a Docker container, as follows:</p>

<pre><code>docker run --rm -it -v &quot;%cd%:/code&quot; lambci/lambda:build-python3.6 sh
</code></pre>

<p>That&rsquo;s if we are using Windows, because of the <code>%cd%</code> part. If you are on Linux use <code>${PWD}</code> instead.</p>

<p>There we will launch an shell in a container, running an image that is pretty similar to Lambda&rsquo;s, although it might not always work (in those cases, use an EC2 instance).</p>

<p>Then, navigate to our <code>/code</code> directory, create a Python virtual environment, activate it, and install the library you want. Or, basically, this:</p>

<pre><code>cd /code
virtualenv env
source env/bin/activate
pip install pillow
</code></pre>

<p>Once you have installed Pillow, you can press <code>Ctrl-C</code> to kill the container. Back on the host, you need to put the libraries folders in the root directory. So, for example, move the folder <code>env/lib/python3.6/site-packages/PIL</code> to the root directory where your .py file is.</p>

<p>It should look like this:</p>

<ul>
<li>ProcessMediaFile.py</li>
<li>PIL/&hellip;</li>
</ul>

<p>ZIP those 2 things and upload them to AWS Lambda. The name of your handler will be ProcessMediaFile.lambda_handler. Also, don&rsquo;t forget to give access to your Service Role in IAM. In my case, my policy looks something like this:</p>

<pre><code>{
    &quot;Version&quot;: &quot;2012-10-17&quot;,
    &quot;Statement&quot;: [
        {
            &quot;Effect&quot;: &quot;Allow&quot;,
            &quot;Action&quot;: [
                &quot;logs:CreateLogGroup&quot;,
                &quot;logs:CreateLogStream&quot;,
                &quot;logs:PutLogEvents&quot;
            ],
            &quot;Resource&quot;: &quot;arn:aws:logs:*:*:*&quot;
        },
        {
            &quot;Effect&quot;: &quot;Allow&quot;,
            &quot;Action&quot;: [
                &quot;*&quot;
            ],
            &quot;Resource&quot;: [
                &quot;arn:aws:s3:::input-bucket/*&quot;,
                &quot;arn:aws:s3:::output-bucket/*&quot;
            ]
        }
    ]
}
</code></pre>
            </article>
          </div>
          
      <div class='entry-meta-bottom'>
        

  <div class="entry-categories"><p><span>Categories</span>
    
    <a href="/categories/articles" title="View all posts in articles">articles</a>
  </p>
</div>



<div class="entry-tags"><p><span>Tags</span>
  
  <a href="/tags/aws-lambda" title="View all posts tagged aws-lambda">aws-lambda</a>
  
  <a href="/tags/pil" title="View all posts tagged pil">pil</a>
  
  <a href="/tags/pillow" title="View all posts tagged pillow">pillow</a>
  
  <a href="/tags/python" title="View all posts tagged python">python</a>
  

</p></div>	</div>


<div class="author-meta">

  <div class="author">
    <img alt='Diego Jancic' src="https://www.gravatar.com/avatar/d5874a9362fed58bb2df043c20345fa2?s=100&d=identicon" class='avatar avatar-72 photo' height='72' width='72'>

    <span>
      Written by:<a href="https://twitter.com/diegojancic" title="Posts by Diego Jancic" rel="author">Diego Jancic</a>        </span>
    </div>
    <div class="bio">
      
      <p>.NET/Python Developer - Serverless advocate</p>
      


      

    


  
  <a class="twitter" target="_blank"
  href="https://twitter.com/diegojancic">
  <i class="fa fa-twitter-square"
  title="twitter icon"></i>
</a>







<a class="stackoverflow" target="_blank"
href="https://stackoverflow.com/users/72350/diego-jancic">
<i class="fa fa-stack-overflow"
title="stackoverflow icon"></i>
</a>



<a class="github" target="_blank"
href="https://github.com/diegojancic">
<i class="fa fa-github"
title="github icon"></i>
</a>


</div>
</div>

</div>
</div>

<section id="comments" class="comments">
  <div id="disqus_thread"></div>
<script>
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "learn-serverless" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

  




</section>
</div>

 



    </div>

    <footer id="site-footer" class="site-footer" role="contentinfo">
	<h1>
    
    <a href=""> Learn-Serverless.org </a>
    
	</h1>

			
			<p class="site-description">We're everywhere.</p>
			

		<div id="menu-footer" class="menu-container menu-footer" role="navigation">
		<div class="menu">

      <ul id="menu-footer-items" class="menu-footer-items">
        
</ul>

</div>	</div>

<ul class="social-media-icons">

        

        


        
        <li>
        <a href="https://twitter.com/learnsrvless"  class="twitter" target="_blank">
            <i class="fa fa-twitter-square" title="twitter"></i>
            <span class="screen-reader-text">twitter</span>
        </a>
        </li>
        

        

        
        <li>
        <a href="mailto:hello@learn-serverless.org"  class="email">
            <i class="fa fa-envelope" title="email"></i>
            <span class="screen-reader-text">email</span>
        </a>
        </li>
        

        

        


        
				</ul>	<div class="design-credit">
		
		<p>&copy; 2018 Learn-Serverless.org</p>
		
		<p>Theme by Nederburg.</p>
		
	</div>
</footer>

  </div>
  <script src="https://d2wg8k1x5s4bdi.cloudfront.net/js/jquery.min.js"></script>
<script src="https://d2wg8k1x5s4bdi.cloudfront.net/js/jquerymigrate.js"></script>
<script src="https://d2wg8k1x5s4bdi.cloudfront.net/js/production.min.js"></script>

</body>
</html>
